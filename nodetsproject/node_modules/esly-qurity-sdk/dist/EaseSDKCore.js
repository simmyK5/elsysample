"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const socketIO = require("socket.io-client");
class EaseSDKCore {
    constructor({ apiKey, baseUrl, wsUrl, debug = false }) {
        if (!apiKey || !baseUrl)
            throw new Error("Error please contact admin");
        this.apiKey = apiKey;
        this.baseUrl = baseUrl.replace(/\/$/, "");
        this.wsUrl = wsUrl ?? this.baseUrl.replace(/^http/, "ws");
        this.debug = debug;
        this.socket = null;
        this.streamId = null;
        this.connected = false;
    }
    log(...args) {
        if (this.debug)
            console.log("[EaseSDK]", ...args);
    }
    async reportIncident({ audio, location, metadata, }) {
        const formData = new FormData();
        formData.append("location", location);
        if (metadata) {
            formData.append("metadata", JSON.stringify(metadata));
        }
        if (audio) {
            formData.append("audio", audio, "recording.wav");
        }
        const res = await fetch(`${this.baseUrl}/api/sdk/incidents`, {
            method: "POST",
            headers: {
                Authorization: `Bearer ${this.apiKey}`,
                // âŒ DO NOT set Content-Type
            },
            body: formData,
        });
        if (!res.ok) {
            throw new Error("Failed to report incident");
        }
        return res.json();
    }
    connectStream(streamId) {
        return new Promise((resolve, reject) => {
            try {
                this.streamId = streamId;
                this.socket = socketIO(`${this.wsUrl}/sdk`, {
                    transports: ["websocket"],
                    query: { apiKey: this.apiKey, streamId },
                });
                this.socket.on("connect", () => {
                    this.connected = true;
                    this.log("Connected to SDK socket");
                    resolve(true);
                });
                this.socket.on("disconnect", () => {
                    this.connected = false;
                    this.log("Disconnected from SDK socket");
                });
                this.socket.on("error", (err) => reject(err));
            }
            catch (err) {
                reject(err);
            }
        });
    }
    sendAudioChunk({ audioBase64, seq, final = false, metadata, }) {
        if (!this.connected || !this.socket)
            throw new Error("Error please contact admin");
        this.socket.emit("audio_chunk", { audioBase64, seq, final, metadata });
    }
    async endStream() {
        if (this.socket) {
            this.socket.disconnect();
            this.connected = false;
            this.socket = null;
        }
    }
}
exports.default = EaseSDKCore;
